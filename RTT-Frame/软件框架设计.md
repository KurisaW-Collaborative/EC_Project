# 软件框架设计（线程、任务设计）

---

## 1.定位任务设计

* 数据接收线程(recgps_thread)：从串口读取GPS模块发送来的原始GPS指令，创建一个消息队列(origps_mq)，在接收到串口部分来的原始GPS数据后，将该数据发送到消息队列(origps_mq)中；并创建一个信号量(origps_sem)，并始终在线程的入口函数中始终持有该信号量。

* 数据解析线程(alygps_thread)：等待消息队列(origps_mq)中的消息，一旦消息队列中有消息，就接收该消息并存入数组中，通过nmealib库函数解析为具体的定位信息，将其打包成一个解析数据集（数组），同时创建一个新的消息队列(pldgps_mq)，并将解析的数据集存入到该消息队列中；此时释放一个信号量(origps_sem)，表示此次数据解析完成，同时再次创建一个信号量(pldgps_sem)，并在线程的入口函数中始终持有该信号量。
* 数据上报线程(upldgps_thread)：等待消息队列(pldgps_mq)中的消息，接收来自alygps_thread线程每次读取的GPS解析数据集，此时释放一个信号量(pldgps_sem)，同时将解析数据集发送给云端，并在云端进行数据的解析。

* 阿里云端进行空间数据可视化，添加一个地理位置的定义（可导出运动轨迹）。

## 2.图传任务设计（原路径规划设计）*

* 图像采集线程(capimg_thread)：通过摄像头进行路况数据的图像帧采集，创建一个消息队列(orimg_mq)，将帧数据存入消息队列中。同时创建一个互斥量(orimg_mux)，在线程的入口函数中始终持有该互斥量。
* 图像压缩线程(cmpresimg_thread)：等待来自图像采集线程中消息队列(orimg_mq)，收到消息后将数据从消息队列中读取出来，同时压缩图像数据为jpeg格式，创建一个信号量(cmpresimg_sem)，将压缩数据通过串口发送给4G模块后启动线程的入口函数，并且在线程入口函数中始终持有该信号量。
* 图像解析线程(alyimg_thread)：4G模块接收到图像数据后，通过移动网络将数据上传到云端或者其他设备上，实现远程监控和控制功能

附：此处可能不参与系统设计，考虑使用单向视频网络传输技术（WebRTC）实现

## 3.监测任务设计

* **环境质量监测线程(envmtor_thread)(实时采集)**
  * 噪声监测子线程(noisemtor_thread_s)：在线程的入口程序中始终尝试去获取全局互斥量(noisemtor_mux)，一旦得到该互斥量，立刻开始对噪声进行检测是否超出阈值，超出后将来自消息队列(noisemtor_mq)中的数据取出并存入另一个消息队列(upnoisemtor_mq)中，串口打印信息提示（“已监测到噪声数据，即将上报云端”），此时立刻释放一个互斥量(noisedata_mux)，等待upnoisemtor_thread_s线程获取该互斥量，调用云端数据上传API将数据发送给云端，提示达到噪声警戒标准，后台管理员可在云端查看对应时刻记录。
  * 空气质量监测子线程(pmtor_thread_s)：在线程的入口程序中始终尝试去获取全局互斥量(pmtor_mux)，一旦得到该互斥量，立刻开始对空气粒子浓度进行检测是否超出阈值，超出后将来自消息队列(pmtor_mq)中的数据取出并存入另一个消息队列(uppmtor_mq)中，串口打印信息提示（“已监测到空气污染数据，即将上报云端”），此时立刻释放一个互斥量(uppmtor_mux)，等待uppmtor_thread_s线程获取该互斥量。
* **气象数据采集线程(capweath_thread)(触发采集)**
  * 温湿度采集子线程(caphutmp_thread_s)：创建一个全局互斥量(uphutmp_mux)，**等待云端报文命令**，一旦检测到数据获取命令，启动线程的入口函数，在线程的入口函数中进行全局互斥量(hutmp_mux)的释放，此时hutmp_device_thread线程会获取到传感器数据。并开始从消息队列中取出温湿度数据，并从串口中打印信息（“已监测到温湿度数据，即将上报云端”）
  * 气压采集子线程(capbmp_thread_s)：创建一个全局 互斥量(upbmp_mux)，**等待云端报文命令**，一旦检测到数据获取命令，启动线程的入口函数，在线程的入口函数中进行全局互斥量(bmp_mux)的释放，此时bmp_device_thread线程会获取到传感器数据。并开始从消息队列中取出气压数据，并从串口中打印信息（“已监测到气压数据，即将上报云端”）
  * 光照采集子线程(capbh_thread_s)：创建一个全局互斥量(upbh_mux)，**等待云端报文命令**，一旦检测到数据获取命令，启动线程的入口函数，在线程的入口函数中进行全局互斥量(bh_mux)的释放，此时bh_device_thread线程会获取到传感器数据。并开始从消息队列中取出光照数据，并从串口中打印信息（“已监测到光照数据，即将上报云端”）
* **云端数据上传线程(upcldd_thread)**
  * 噪声污染上报子线程(upnoisemtor_thread_s)：在线程中尝试获取互斥量(upnoisemtor_mux)，获取到后启动线程的入口函数，并从消息队列(upnoisemtor_mq)中进行噪声数据的读取，调用上传数据API，将数据上发服务器，释放互斥量upnoisemtor_mux，并从串口中打印信息（“已上传噪声数据”）
  * 空气污染上报子线程(uppmtor_thread_s)：在线程中尝试获取互斥量(uppmtor_mux)，获取到后启动线程的入口函数，并从消息队列(uppmtor_mq)中进行空气粒子浓度数据的读取 ，调用上传数据API，将数据上发服务器，释放互斥量uppmtor_mux，并从串口中打印信息（“已上传空气污染数据”）
  * 温湿度数据上报子线程(uphutmp_thread_s)：在线程中尝试获取互斥量(uphutmp_mux)，获取到后启动线程的入口函数，并从消息队列中进行温湿度数据的读取，调用上传数据API，将数据上发服务器，释放互斥量uphutmp_mux，并从串口中打印信息（“已上传温湿度数据”）
  * 气压数据上报子线程(upbmp_thread_s)：在线程中尝试获取互斥量(upbmp_mux)，获取到后启动线程的入口喊出，并从消息队列中进行气压数据的读取，调用上传数据API，将数据上发服务器，释放互斥量upbmp_mux，并从串口中打印信息（“已上传气压数据”）
  * 光照数据上报子线程(upbh_thread_s)：在线程中尝试获取互斥量(upbh_mux)，获取到后启动线程的入口喊出，并从消息队列中进行光照数据的读取，调用上传数据API，将数据上发服务器，释放互斥量upbh_mux，并从串口中打印信息（“已上传光照数据”）

![image-20230331184020865](https://raw.githubusercontent.com/kurisaW/picbed/main/img/202303311840163.png)